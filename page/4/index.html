<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>H博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="编程博客">
<meta name="keywords" content="c++ java mysql shell linux h博客 android docker git laravel php python javascript python">
<meta property="og:type" content="website">
<meta property="og:title" content="H博客">
<meta property="og:url" content="https://blog.newtao.vip/page/4/index.html">
<meta property="og:site_name" content="H博客">
<meta property="og:description" content="编程博客">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="H博客">
<meta name="twitter:description" content="编程博客">
  
    <link rel="alternate" href="/atom.xml" title="H博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="/css/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<style>
.breathe-div {
    width: 200px;
    height: 200px;
    border: 1px solid #2b92d4;
    border-radius: 50%;
    text-align: center;
    cursor: pointer;
    margin:0px auto;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    overflow: hidden;
    z-index: 10;
    -webkit-animation-timing-function: ease-in-out;
    -webkit-animation-name: breathe;
    -webkit-animation-duration: 1500ms;
    -webkit-animation-iteration-count: infinite;
    -webkit-animation-direction: alternate;
}

@-webkit-keyframes breathe {
    0% {
        opacity: .4;
        box-shadow: 0 1px 2px rgba(0, 147, 223, 0.4), 0 1px 1px rgba(0, 147, 223, 0.1) inset;
    }

    100% {
        opacity: 1;
        border: 1px solid rgba(59, 235, 235, 0.7);
        box-shadow: 0 1px 30px #0093df, 0 1px 20px #0093df inset;
    }
}
.breathe-point{position:absolute;left:50%; top:150px;}
.breathe-div{position:absolute;left:-100px; top:-100px }
</style>
<body>
  <div class="breathe-point">
  <div class="breathe-div"></div>
  </div>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">H博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技术博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.newtao.vip"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="true-git_proxy" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/12/git_proxy/" class="article-date">
  <time datetime="2020-03-12T02:40:46.389Z" itemprop="datePublished">2020-03-12</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/GIT/">GIT</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/12/git_proxy/">Git proxy</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="设置ss"><a href="#设置ss" class="headerlink" title="设置ss"></a>设置ss</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global http.proxy &apos;socks5://127.0.0.1:1090&apos;</span><br><span class="line">git config --global https.proxy &apos;socks5://127.0.0.1:1090&apos;</span><br></pre></td></tr></table></figure>

<h1 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global https.proxy http://127.0.0.1:1080</span><br><span class="line">git config --global https.proxy https://127.0.0.1:1080</span><br></pre></td></tr></table></figure>

<h1 id="取消代理"><a href="#取消代理" class="headerlink" title="取消代理"></a>取消代理</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global --unset http.proxy</span><br><span class="line">git config --global --unset https.proxy</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2020/03/12/git_proxy/" data-id="ckcfu66eg0013o578tqvfmycp" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="true-php_ptrace_input" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/05/php_ptrace_input/" class="article-date">
  <time datetime="2020-03-05T06:55:21.081Z" itemprop="datePublished">2020-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/PHP/">PHP</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/05/php_ptrace_input/">PHP failed to ptrace(PEEKDATA)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p>PHP failed to ptrace(PEEKDATA) pid 13659 Input/output error错误解决方法</p>
</li>
<li><p>现在改linux内核文件打开限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ulimit -SHn 51200</span><br></pre></td></tr></table></figure>
</li>
<li><p>再修改nginx.conf配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">worker_rlimit_nofile 51200;</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后修改PHP-fpm.conf配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rlimit_files = 51200</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2020/03/05/php_ptrace_input/" data-id="ckcfu66ij002zo578w9ssmvcw" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="true-wget" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/03/05/wget/" class="article-date">
  <time datetime="2020-03-05T06:34:40.652Z" itemprop="datePublished">2020-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/linux/">linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/03/05/wget/">Wget复制网站</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li>利用wget复制网站<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget -E -c -r -p -k -np -l 100  http://localhost/example/</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>2.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line">GNU Wget 1.20.3，非交互式的网络文件下载工具。</span><br><span class="line">用法： wget [选项]... [URL]...</span><br><span class="line"></span><br><span class="line">长选项所必须的参数在使用短选项时也是必须的。</span><br><span class="line"></span><br><span class="line">启动：</span><br><span class="line">  -V,  --version                   显示 Wget 的版本信息并退出</span><br><span class="line">  -h,  --help                      打印此帮助</span><br><span class="line">  -b,  --background                启动后转入后台</span><br><span class="line">  -e,  --execute=命令              运行一个“.wgetrc”风格的命令</span><br><span class="line"></span><br><span class="line">日志和输入文件：</span><br><span class="line">  -o,  --output-file=文件          将日志信息写入 FILE</span><br><span class="line">  -a,  --append-output=文件        将信息添加至 FILE</span><br><span class="line">  -q,  --quiet                     安静模式 (无信息输出)</span><br><span class="line">  -v,  --verbose                   详尽的输出 (此为默认值)</span><br><span class="line">  -nv, --no-verbose                关闭详尽输出，但不进入安静模式</span><br><span class="line">       --report-speed=类型         以 &lt;类型&gt; 报告带宽。类型可以是 bits</span><br><span class="line">  -i,  --input-file=文件           下载本地或外部 &lt;文件&gt; 中的 URL</span><br><span class="line">  -F,  --force-html                把输入文件当成 HTML 文件</span><br><span class="line">  -B,  --base=URL                  解析相对于 URL 的 HTML 输入文件链接 (-i -F)</span><br><span class="line">       --config=文件               指定要使用的配置文件</span><br><span class="line">       --no-cookies                不读取任何配置文件</span><br><span class="line">       --rejected-log=文件         将拒绝 URL 的原因写入 &lt;文件&gt;。</span><br><span class="line"></span><br><span class="line">下载：</span><br><span class="line">  -t,  --tries=数字                设置重试次数为 &lt;数字&gt; (0 代表无限制)</span><br><span class="line">       --retry-connrefused         即使拒绝连接也是重试</span><br><span class="line">       --retry-on-http-error=ERRORS    提供以逗号分隔的列表，列出遇到时进行重试的 HTTP 错误</span><br><span class="line">  -O,  --output-document=文件      将文档写入 FILE</span><br><span class="line">  -nc, --no-clobber                不要下载已存在将被覆盖的文件</span><br><span class="line">       --no-netrc                  不要尝试从 .netrc 获取凭据</span><br><span class="line">  -c,  --continue                  断点续传下载文件</span><br><span class="line">       --start-pos=偏移量          从由零计数的 &lt;偏移量&gt; 开始下载</span><br><span class="line">       --progress=类型             选择进度条类型</span><br><span class="line">       --show-progress             在任意啰嗦状态下都显示进度条</span><br><span class="line">  -N,  --timestamping              只获取比本地文件新的文件</span><br><span class="line">       --no-if-modified-since      不要在时间戳 (timestamping) 模式下使用</span><br><span class="line">                                     if-modified-since get 条件请求</span><br><span class="line">       --no-use-server-timestamps  不用服务器上的时间戳来设置本地文件</span><br><span class="line">  -S,  --server-response           打印服务器响应</span><br><span class="line">       --spider                    不下载任何文件</span><br><span class="line">  -T,  --timeout=SECONDS           将所有超时设为 SECONDS 秒</span><br><span class="line">       --dns-timeout=SECS          设置 DNS 查寻超时为 SECS 秒</span><br><span class="line">       --connect-timeout=SECS      设置连接超时为 SECS 秒</span><br><span class="line">       --read-timeout=SECS         设置读取超时为 SECS 秒</span><br><span class="line">  -w,  --wait=SECONDS              等待间隔为 SECONDS 秒</span><br><span class="line">       --waitretry=SECONDS         在获取文件的重试期间等待 1..SECONDS 秒</span><br><span class="line">       --random-wait               获取多个文件时，每次随机等待间隔 (0.5~1.5)*WAIT 秒</span><br><span class="line">       --no-proxy                  禁止使用代理</span><br><span class="line">  -Q,  --quota=数字                设置获取配额为 &lt;数字&gt; 字节</span><br><span class="line">       --bind-address=ADDRESS      绑定至本地主机上的 ADDRESS (主机名或是 IP)</span><br><span class="line">       --limit-rate=RATE           限制下载速率为 RATE</span><br><span class="line">       --no-dns-cache              关闭 DNS 查询缓存</span><br><span class="line">       --restrict-file-names=系统  限定文件名中的字符为 &lt;系统&gt; 允许的字符</span><br><span class="line">       --ignore-case               匹配文件/目录时忽略大小写</span><br><span class="line">  -4,  --inet4-only                仅连接至 IPv4 地址</span><br><span class="line">  -6,  --inet6-only                仅连接至 IPv6 地址</span><br><span class="line">       --prefer-family=地址族      首先连接至指定家族（IPv6，IPv4 或 none）的地址</span><br><span class="line">       --user=用户                 将 ftp 和 http 的用户名均设置为 &lt;用户&gt;</span><br><span class="line">       --password=密码             将 ftp 和 http 的密码均设置为 &lt;密码&gt;</span><br><span class="line">       --ask-password              提示输入密码</span><br><span class="line">       --use-askpass=命令          指定用于请求用户名和密码的凭据管理器。</span><br><span class="line">                                     如果没有提供指定命令，程序将使用 WGET_ASKPASS 或</span><br><span class="line">                                     SSH_ASKPASS 环境变量。</span><br><span class="line">       --no-iri                    关闭 IRI 支持</span><br><span class="line">       --local-encoding=ENC        使用 ENC 作为 IRI (国际化资源标识符) 的本地编码</span><br><span class="line">       --remote-encoding=ENC       使用 ENC 作为默认远程编码</span><br><span class="line">       --unlink                    覆盖前移除文件</span><br><span class="line">       --xattr                     turn on storage of metadata in extended file attributes</span><br><span class="line"></span><br><span class="line">目录：</span><br><span class="line">  -nd, --no-directories            不创建目录</span><br><span class="line">  -x,  --force-directories         强制创建目录</span><br><span class="line">  -nH, --no-host-directories       不要创建主 (host) 目录</span><br><span class="line">       --protocol-directories      在目录中使用协议名称</span><br><span class="line">  -P,  --directory-prefix=前缀     保存文件到 &lt;前缀&gt;/..</span><br><span class="line">       --cut-dirs=数字             忽略远程目录中 &lt;数字&gt; 个目录层。</span><br><span class="line"></span><br><span class="line">HTTP 选项：</span><br><span class="line">       --http-user=用户            设置 http 用户名为 &lt;用户&gt;</span><br><span class="line">       --http-password=密码        设置 http 密码为 &lt;密码&gt;</span><br><span class="line">       --no-cache                  不使用服务器缓存的数据。</span><br><span class="line">       --default-page=NAME         改变默认页 (通常是“index.html”)。</span><br><span class="line">  -E,  --adjust-extension          以合适的扩展名保存 HTML/CSS 文档</span><br><span class="line">       --ignore-length             忽略头部的‘Content-Length’区域</span><br><span class="line">       --header=字符串             在头部插入 &lt;字符串&gt;</span><br><span class="line">       --compression=类型          选择压缩类型，值可以为 auto、gzip 和 none。（默认：none）</span><br><span class="line">       --max-redirect              每页所允许的最大重定向</span><br><span class="line">       --proxy-user=用户           使用 &lt;用户&gt; 作为代理用户名</span><br><span class="line">       --proxy-password=密码       使用 &lt;密码&gt; 作为代理密码</span><br><span class="line">       --referer=URL               在 HTTP 请求头包含‘Referer: URL’</span><br><span class="line">       --save-headers              将 HTTP 头保存至文件。</span><br><span class="line">  -U,  --user-agent=代理           标识自己为 &lt;代理&gt; 而不是 Wget/VERSION。</span><br><span class="line">       --no-http-keep-alive        禁用 HTTP keep-alive (持久连接)。</span><br><span class="line">       --no-cookies                不使用 cookies。</span><br><span class="line">       --load-cookies=文件         会话开始前从 &lt;文件&gt; 中载入 cookies。</span><br><span class="line">       --save-cookies=文件         会话结束后保存 cookies 至 FILE。</span><br><span class="line">       --keep-session-cookies      载入并保存会话 (非永久) cookies。</span><br><span class="line">       --post-data=字符串          使用 POST 方式；把 &lt;字串&gt;作为数据发送。</span><br><span class="line">       --post-file=文件            使用 POST 方式；发送 &lt;文件&gt; 内容。</span><br><span class="line">       --method=HTTP方法           在请求中使用指定的 &lt;HTTP 方法&gt;。</span><br><span class="line">       --post-data=字符串          把 &lt;字串&gt; 作为数据发送，必须设置 --method</span><br><span class="line">       --post-file=文件            发送 &lt;文件&gt; 内容，必须设置 --method</span><br><span class="line">       --content-disposition       当选择本地文件名时允许 Content-Disposition</span><br><span class="line">                                   头部 (实验中)。</span><br><span class="line">       --content-on-error          在服务器错误时输出接收到的内容</span><br><span class="line">       --auth-no-challenge         不先等待服务器询问就发送基本 HTTP 验证信息。</span><br><span class="line"></span><br><span class="line">HTTPS (SSL/TLS) 选项：</span><br><span class="line">       --secure-protocol=PR         选择安全协议，值可以是 auto、SSLv2、</span><br><span class="line">                                    SSLv3、TLSv1、TLSv1_1、TLSv1_2 或 PFS</span><br><span class="line">       --https-only                 只跟随安全的 HTTPS 链接</span><br><span class="line">       --no-check-certificate       不要验证服务器的证书。</span><br><span class="line">       --certificate=文件           客户端证书文件。</span><br><span class="line">       --certificate-type=类型      客户端证书类型，PEM 或 DER。</span><br><span class="line">       --private-key=文件           私钥文件。</span><br><span class="line">       --private-key-type=类型      私钥文件类型，PEM 或 DER。</span><br><span class="line">       --ca-certificate=文件        带有一组 CA 证书的文件。</span><br><span class="line">       --ca-directory=DIR           保存 CA 证书的哈希列表的目录。</span><br><span class="line">       --ca-certificate=文件        带有一组 CA 证书的文件。</span><br><span class="line">       --pinnedpubkey=文件/散列值  用于验证节点的公钥（PEM/DER）文件或</span><br><span class="line">                                   任何数量的 sha256 散列值，以 base64 编码、</span><br><span class="line">                                   “sha256//” 开头、用“;”间隔</span><br><span class="line">       --random-file=文件           用于初始化 SSL 伪随机数生成器（PRNG）的文件，</span><br><span class="line">                                      应含有随机数据</span><br><span class="line"></span><br><span class="line">       --ciphers=STR           Set the priority string (GnuTLS) or cipher list string (OpenSSL) directly.</span><br><span class="line">                                   Use with care. This option overrides --secure-protocol.</span><br><span class="line">                                   The format and syntax of this string depend on the specific SSL/TLS engine.</span><br><span class="line">HSTS 选项：</span><br><span class="line">       --no-hsts                   禁用 HSTS</span><br><span class="line">       --hsts-file                 HSTS 数据库路径（将覆盖默认值）</span><br><span class="line"></span><br><span class="line">FTP 选项：</span><br><span class="line">       --ftp-user=用户             设置 ftp 用户名为 &lt;用户&gt;。</span><br><span class="line">       --ftp-password=密码         设置 ftp 密码为 &lt;密码&gt;</span><br><span class="line">       --no-remove-listing         不要删除‘.listing’文件</span><br><span class="line">       --no-glob                   不在 FTP 文件名中使用通配符展开</span><br><span class="line">       --no-passive-ftp            禁用“passive”传输模式</span><br><span class="line">       --preserve-permissions      保留远程文件的权限</span><br><span class="line">       --retr-symlinks             递归目录时，获取链接的文件 (而非目录)</span><br><span class="line"></span><br><span class="line">FTPS 选项：</span><br><span class="line">       --ftps-implicit                 使用隐式 FTPS（默认端口 990）</span><br><span class="line">       --ftps-resume-ssl               打开数据连接时继续控制连接中的 SSL/TLS 会话</span><br><span class="line">       --ftps-clear-data-connection    只加密控制信道；数据传输使用明文</span><br><span class="line">       --ftps-fallback-to-ftp          回落到 FTP，如果目标服务器不支持 FTPS</span><br><span class="line">WARC 选项：</span><br><span class="line">       --warc-file=文件名          在一个 .warc.gz 文件里保持请求/响应数据</span><br><span class="line">       --warc-header=字符串        在头部插入 &lt;字符串&gt;</span><br><span class="line">       --warc-max-size=数字        将 WARC 的最大尺寸设置为 &lt;数字&gt;</span><br><span class="line">       --warc-cdx                  写入 CDX 索引文件</span><br><span class="line">       --warc-dedup=文件名         不要记录列在此 CDX 文件内的记录</span><br><span class="line">       --no-warc-compression       不要 GZIP 压缩 WARC 文件</span><br><span class="line">       --no-warc-digests           不要计算 SHA1 摘要</span><br><span class="line">       --no-warc-keep-log          不要在 WARC 记录中存储日志文件</span><br><span class="line">       --warc-tempdir=目录         WARC 写入器的临时文件目录</span><br><span class="line"></span><br><span class="line">递归下载：</span><br><span class="line">  -r,  --recursive                 指定递归下载</span><br><span class="line">  -l,  --level=数字                最大递归深度 (inf 或 0 代表无限制，即全部下载)。</span><br><span class="line">       --delete-after              下载完成后删除本地文件</span><br><span class="line">  -k,  --convert-links             让下载得到的 HTML 或 CSS 中的链接指向本地文件</span><br><span class="line">       --convert-file-only         只转换 URL 的文件部分（一般叫做“基础名”/basename）</span><br><span class="line">       --backups=N                 写入文件 X 前，轮换移动最多 N 个备份文件</span><br><span class="line">  -K,  --backup-converted          在转换文件 X 前先将它备份为 X.orig。</span><br><span class="line">  -m,  --mirror                    -N -r -l inf --no-remove-listing 的缩写形式。</span><br><span class="line">  -p,  --page-requisites           下载所有用于显示 HTML 页面的图片之类的元素。</span><br><span class="line">       --strict-comments           用严格方式 (SGML) 处理 HTML 注释。</span><br><span class="line"></span><br><span class="line">递归接受/拒绝：</span><br><span class="line">  -A,  --accept=列表               逗号分隔的可接受的扩展名列表</span><br><span class="line">  -R,  --reject=列表               逗号分隔的要拒绝的扩展名列表</span><br><span class="line">       --accept-regex=REGEX        匹配接受的 URL 的正则表达式</span><br><span class="line">       --reject-regex=REGEX        匹配拒绝的 URL 的正则表达式</span><br><span class="line">       --regex-type=类型           正则类型 (posix)</span><br><span class="line">  -D,  --domains=列表              逗号分隔的可接受的域名列表</span><br><span class="line">       --exclude-domains=列表      逗号分隔的要拒绝的域名列表</span><br><span class="line">       --follow-ftp                跟踪 HTML 文档中的 FTP 链接</span><br><span class="line">       --follow-tags=列表          逗号分隔的跟踪的 HTML 标识列表</span><br><span class="line">       --ignore-tags=列表          逗号分隔的忽略的 HTML 标识列表</span><br><span class="line">  -H,  --span-hosts                递归时转向外部主机</span><br><span class="line">  -L,  --relative                  仅跟踪相对链接</span><br><span class="line">  -I,  --include-directories=列表  允许目录的列表</span><br><span class="line">       --trust-server-names        使用重定向 URL 的最后一段作为本地文件名</span><br><span class="line">  -X,  --exclude-directories=列表  排除目录的列表</span><br><span class="line">  -np, --no-parent                 不追溯至父目录</span><br><span class="line"></span><br><span class="line">请将错误报告、问题和讨论寄信至 &lt;bug-wget@gnu.org&gt;</span><br><span class="line">和/或在 https://savannah.gnu.org/bugs/?func=additem&amp;group=wget 开 issue 进行讨论。</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2020/03/05/wget/" data-id="ckcfu66ky004ro5783j23ey1z" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="true-docker" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/05/docker/" class="article-date">
  <time datetime="2020-02-05T14:50:54.254Z" itemprop="datePublished">2020-02-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/05/docker/">Docker 镜像加速 阿里云</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p>安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># step 1: 安装必要的一些系统工具</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line"># step 2: 安装GPG证书</span><br><span class="line">curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line"># Step 3: 写入软件源信息</span><br><span class="line">sudo add-apt-repository &quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</span><br><span class="line"># Step 4: 更新并安装 Docker-CE</span><br><span class="line">sudo apt-get -y update</span><br><span class="line">sudo apt-get -y install docker-ce</span><br></pre></td></tr></table></figure>
</li>
<li><p>登录阿里云搜索 容器镜像服务 -&gt; 在页面上找到 镜像加速器 -&gt;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&apos;EOF&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://ciz8m8sm.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2020/02/05/docker/" data-id="ckcfu66ec000zo578ssdok8q4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="true-7zip" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/17/7zip/" class="article-date">
  <time datetime="2020-01-17T08:18:25.988Z" itemprop="datePublished">2020-01-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/shell/">shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/17/7zip/">7zip解压 压缩</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>压缩<br>7z a -p密码 压缩路径及文件名 源路径及文件名<br>解压<br>7z x -p密码 压缩包路径 -o解压路径</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2020/01/17/7zip/" data-id="ckcfu66c70000o5780gn0qw69" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="true-curl" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/07/curl/" class="article-date">
  <time datetime="2020-01-07T08:41:21.869Z" itemprop="datePublished">2020-01-07</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/07/curl/">Curl解压gzip</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>curl 解压gzip</p>
<pre><code>$headers = array(
        //&quot;Content-type:application/json;charset=&apos;utf-8&apos;&quot;,
        &quot;Cache-Control:no-cache&quot;,
        &quot;Pragma:no-cache&quot;,
        //&quot;accept-charset:utf-8&quot;,
        &quot;Accept-Encoding:gzip&quot;,
        &quot;User-Agent:Dalvik/2.1.0 (Linux; U; Android 5.1.1;Build/LMY47V)&quot;,
        &quot;Host:www.domain.cn&quot;,
        //&apos;Transfer-Encoding:chunked&apos;, 压缩不能用这项
        //&quot;Content-Type:application/x-www-form-urlencoded&quot;,
        //&quot;Connection:Keep-Alive&quot;,
    );

/*
 * 可写文件
$sourceFile=&quot;tmp.txt&quot;;
$fp = fopen($sourceFile, &quot;w&quot;);
*/

$curl = curl_init();
curl_setopt($curl, CURLOPT_URL, $url);
curl_setopt($curl, CURLOPT_HEADER, false);
curl_setopt($curl, CURLOPT_NOBODY, true);
curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
curl_setopt($curl, CURLOPT_ENCODING, &apos;gzip&apos;); //curl解压gzip页面内容
curl_setopt($curl, CURLOPT_FORBID_REUSE, true);
curl_setopt($curl, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);
curl_setopt($curl, CURLOPT_HTTPGET, true);
//curl_setopt($curl, CURLOPT_FILE, $fp);
$data = curl_exec($curl);
curl_close($curl);

//file_put_contents(&apos;tmpdata.txt&apos;,$data);
echo bin2hex($data);    //可查看下16进制
$ret = gzuncompress($data);

print_r(json_decode($ret,true)</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2020/01/07/curl/" data-id="ckcfu66dx000po578dbhwdopb" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="true-openwrt" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/24/openwrt/" class="article-date">
  <time datetime="2019-12-24T06:41:55.636Z" itemprop="datePublished">2019-12-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/24/openwrt/">Openwrt ssh socks5转发</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p>删除dropbear ssh  scp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /usr/bin/ssh #删除ssh软链接</span><br><span class="line">rm -rf /usr/bin/scp #删除scp软链接</span><br><span class="line">opkg update #更新列表</span><br><span class="line">opkg install openssh-client openssh-keygen #安装openssh客户端</span><br></pre></td></tr></table></figure>
</li>
<li><p>Openwrt生在ssh密钥并上传到服务器端：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -y -f ~/.ssh/id_rsa &amp;&amp; cat ~/.ssh/id_rsa.pub | ssh root@server &quot;cat - &gt;&gt; ~/.ssh/authorized_keys&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现ssh转发：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -NfD 0.0.0.0:7070 user@server</span><br></pre></td></tr></table></figure>
</li>
<li><p>可加入开机启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;ssh -CNfD 192.168.1.1:7070 user@server &gt;/dev/null 2&gt;&amp;1 &amp;&apos; &gt;&gt; /etc/rc.local</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果网络断开或重新拨号SSH会断开，可新建shell脚本监控ssh自动重新连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">    while true</span><br><span class="line">    do</span><br><span class="line">        if netstat -tlnp|grep &quot;:7070&quot;</span><br><span class="line">        then</span><br><span class="line">            echo &quot;ssh is working&quot;</span><br><span class="line">        else</span><br><span class="line">            ssh -CNfD 192.168.1.1:7070 user@server &gt;/dev/null 2&gt;&amp;1 &amp;</span><br><span class="line">        fi</span><br><span class="line">    sleep 300</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
</li>
<li><p>autossh</p>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2019/12/24/openwrt/" data-id="ckcfu66i4002no578cbvl9z8e" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="true-autossh" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/24/autossh/" class="article-date">
  <time datetime="2019-12-24T01:13:04.453Z" itemprop="datePublished">2019-12-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/24/autossh/">autossh</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>autossh 是一个用来启动 ssh 并进行监控的程序，可在需要时重启 ssh，如果程序问题或者是网络问题。其灵感和机制来自于 rstunnel (Reliable SSH Tunnel). autossh 1.2 的方法已经改变：autossh 使用 ssh 来构造一个 ssh 重定向循环(本地到远程和远程到本地)，然后发送测试数据并获得返回结果。</p>
<p>内网主机主动连接到外网主机，又被称作反向连接(Reverse Connection)，这样NAT路由/防火墙就会在内网主机和外网主机之间建立映射即可相互通信了。但这种映射是路由网关自动维持的，不会持续下去，如果连接断开或者网络不稳定都会导致通信失败，这时内网主机需要自动重连机制了。</p>
<p>参数：</p>
<p>-M为autossh参数， -CqTfnN -D 为ssh参数<br>-M 5678 : 负责通过5678端口监视连接状态，连接有问题时就会自动重连<br>-C ：启动数据压缩传输<br>-q ：安静模式运行，忽略提示和错误<br>-T ：不占用shell<br>-f ：后台运行<br>-n ：配合 -f 参数使用<br>-N ：不执行远程命令，专为端口转发度身打造<br>-D 192.168.0.2:7070 ：指定一个本地机器 “动态的“ 应用程序端口转发，如果不加IP地址，默认只监听127.0.0.1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#将在&apos;x.x.x.x&apos;主机上开启一个本地侦听地址:18081,访问本地18081将转发至10.10.3.x:8080</span><br><span class="line"># autossh -M 9090 -fCNR 18081:10.10.3.x:8080 root@x.x.x.x</span><br></pre></td></tr></table></figure>

<p>隧道</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># autossh -M20000 -f -i ~/.ssh/id_rsa -Ng -D 7080 user@vps_host</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2019/12/24/autossh/" data-id="ckcfu66du000mo578cfw157em" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="true-kubernetes" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/21/kubernetes/" class="article-date">
  <time datetime="2019-12-21T07:29:00.115Z" itemprop="datePublished">2019-12-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/21/kubernetes/">kubernetes 国内 部署</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原文 <a href="https://www.cnblogs.com/tylerzhou/p/10971336.html" target="_blank" rel="noopener">https://www.cnblogs.com/tylerzhou/p/10971336.html</a></p>
<ol>
<li><p>修改主机名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#master节点:</span><br><span class="line">hostnamectl set-hostname node</span><br><span class="line">#node1节点：</span><br><span class="line">hostnamectl set-hostname node_1</span><br><span class="line">#node2节点:</span><br><span class="line">hostnamectl set-hostname node_2</span><br></pre></td></tr></table></figure>
</li>
<li><p>基本配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#修改/etc/hosts文件</span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.*.100 k8s-master</span><br><span class="line">192.168.*.101 k8s-node1</span><br><span class="line">192.168.*.102 k8s-node2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#关闭防火墙和selinux</span><br><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br><span class="line">sed -i &apos;s/^SELINUX=enforcing$/SELINUX=disabled/&apos; /etc/selinux/config &amp;&amp; setenforce 0</span><br><span class="line"></span><br><span class="line">#关闭swap</span><br><span class="line">swapoff -a</span><br><span class="line">yes | cp /etc/fstab /etc/fstab_bak</span><br><span class="line">cat /etc/fstab_bak |grep -v swap &gt; /etc/fstab</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置时间同步<br>使用chrony同步时间，配置master节点与网络NTP服务器同步时间，所有node节点与master节点同步时间。</p>
</li>
</ol>
<p>配置master节点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#安装chrony：</span><br><span class="line">yum install -y chrony</span><br><span class="line">#注释默认ntp服务器</span><br><span class="line">sed -i &apos;s/^server/#&amp;/&apos; /etc/chrony.conf</span><br><span class="line">#指定上游公共 ntp 服务器，并允许其他节点同步时间</span><br><span class="line">cat &gt;&gt; /etc/chrony.conf &lt;&lt; EOF</span><br><span class="line">server 0.asia.pool.ntp.org iburst</span><br><span class="line">server 1.asia.pool.ntp.org iburst</span><br><span class="line">server 2.asia.pool.ntp.org iburst</span><br><span class="line">server 3.asia.pool.ntp.org iburst</span><br><span class="line">allow all</span><br><span class="line">EOF</span><br><span class="line">#重启chronyd服务并设为开机启动：</span><br><span class="line">systemctl enable chronyd &amp;&amp; systemctl restart chronyd</span><br><span class="line">#开启网络时间同步功能</span><br><span class="line">timedatectl set-ntp true</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置所有node节点：<br>(注意修改master IP地址)<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#安装chrony：</span><br><span class="line">yum install -y chrony</span><br><span class="line">#注释默认服务器</span><br><span class="line">sed -i &apos;s/^server/#&amp;/&apos; /etc/chrony.conf</span><br><span class="line">#指定内网 master节点为上游NTP服务器</span><br><span class="line">echo server 192.168.92.56 iburst &gt;&gt; /etc/chrony.conf</span><br><span class="line">#重启服务并设为开机启动：</span><br><span class="line">systemctl enable chronyd &amp;&amp; systemctl restart chronyd</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>所有节点执行chronyc sources命令，查看存在以^*开头的行，说明已经与服务器时间同步</p>
<p>修改iptables相关参数<br>RHEL / CentOS 7上的一些用户报告了由于iptables被绕过而导致流量路由不正确的问题。创建/etc/sysctl.d/k8s.conf文件，添加如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="line">vm.swappiness = 0</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 使配置生效</span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>加载ipvs相关模块<br>由于ipvs已经加入到了内核的主干，所以为kube-proxy开启ipvs的前提需要加载以下的内核模块：<br>在所有的Kubernetes节点执行以下脚本:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line">modprobe -- ip_vs</span><br><span class="line">modprobe -- ip_vs_rr</span><br><span class="line">modprobe -- ip_vs_wrr</span><br><span class="line">modprobe -- ip_vs_sh</span><br><span class="line">modprobe -- nf_conntrack_ipv4</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#执行脚本</span><br><span class="line">chmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>上面脚本创建了/etc/sysconfig/modules/ipvs.modules文件，保证在节点重启后能自动加载所需模块。 使用lsmod | grep -e ip_vs -e nf_conntrack_ipv4命令查看是否已经正确加载所需的内核模块。<br>接下来还需要确保各个节点上已经安装了ipset软件包。 为了便于查看ipvs的代理规则，最好安装一下管理工具ipvsadm。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ipset ipvsadm -y</span><br></pre></td></tr></table></figure>

<ol start="6">
<li><p>安装Docker<br>Kubernetes默认的容器运行时仍然是Docker，使用的是kubelet中内置dockershim CRI实现。需要注意的是，Kubernetes 1.13最低支持的Docker版本是1.11.1，最高支持是18.06，而Docker最新版本已经是18.09了，故我们安装时需要指定版本为18.06.1-ce</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#配置docker yum源</span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line">#安装指定版本，这里安装18.06</span><br><span class="line">yum list docker-ce --showduplicates | sort -r</span><br><span class="line">yum install -y docker-ce-18.06.1.ce-3.el7</span><br><span class="line">systemctl start docker &amp;&amp; systemctl enable docker</span><br></pre></td></tr></table></figure>

<ul>
<li>安装kubeadm、kubelet、kubectl 官方安装文档可以参考：<a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/independent/install-kubeadm/</a><br>1) kubelet 在群集中所有节点上运行的核心组件, 用来执行如启动pods和containers等操作。<br>2) ubeadm 引导启动k8s集群的命令行工具，用于初始化 Cluster。<br>3) kubectl 是 Kubernetes 命令行工具。通过 kubectl 可以部署和管理应用，查看各种资源，创建、删除和更新各种组件。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#配置kubernetes.repo的源，由于官方源国内无法访问，这里使用阿里云yum源</span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">#在所有节点上安装指定版本 kubelet、kubeadm 和 kubectl</span><br><span class="line">yum install -y kubelet-1.13.1 kubeadm-1.13.1 kubectl-1.13.1</span><br><span class="line"></span><br><span class="line">#启动kubelet服务</span><br><span class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>部署master节点<br>完整的官方文档可以参考：<br><a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank" rel="noopener">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/</a><br><a href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/" target="_blank" rel="noopener">https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/</a><br>Master节点执行初始化：<br>注意这里执行初始化用到了- -image-repository选项，指定初始化需要的镜像源从阿里云镜像仓库拉取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init \</span><br><span class="line">    --apiserver-advertise-address=192.168.92.56 \</span><br><span class="line">    --image-repository registry.aliyuncs.com/google_containers \</span><br><span class="line">    --kubernetes-version v1.13.1 \</span><br><span class="line">    --pod-network-cidr=10.244.0.0/16</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>初始化命令说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--apiserver-advertise-address</span><br></pre></td></tr></table></figure>

<p>指明用 Master 的哪个 interface 与 Cluster 的其他节点通信。如果 Master 有多个 interface，建议明确指定，如果不指定，kubeadm 会自动选择有默认网关的 interface。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--pod-network-cidr</span><br></pre></td></tr></table></figure>

<p>指定 Pod 网络的范围。Kubernetes 支持多种网络方案，而且不同网络方案对 –pod-network-cidr 有自己的要求，这里设置为 10.244.0.0/16 是因为我们将使用 flannel 网络方案，必须设置成这个 CIDR。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--image-repository</span><br></pre></td></tr></table></figure>

<p>Kubenetes默认Registries地址是 k8s.gcr.io，在国内并不能访问 gcr.io，在1.13版本中我们可以增加–image-repository参数，默认值是 k8s.gcr.io，将其指定为阿里云镜像地址：registry.aliyuncs.com/google_containers。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--kubernetes-version=v1.13.1</span><br></pre></td></tr></table></figure>

<p>关闭版本探测，因为它的默认值是stable-1，会导致从<a href="https://dl.k8s.io/release/stable-1.txt下载最新的版本号，我们可以将其指定为固定版本（最新版：v1.13.1）来跳过网络请求。" target="_blank" rel="noopener">https://dl.k8s.io/release/stable-1.txt下载最新的版本号，我们可以将其指定为固定版本（最新版：v1.13.1）来跳过网络请求。</a><br>初始化过程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">ght] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action in beforehand using &apos;kubeadm config images pull&apos;</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span><br><span class="line">[kubelet-start] Activating the kubelet service</span><br><span class="line">[certs] Using certificateDir folder &quot;/etc/kubernetes/pki&quot;</span><br><span class="line">[certs] Generating &quot;etcd/ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd/healthcheck-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver-etcd-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;etcd/server&quot; certificate and key</span><br><span class="line">[certs] etcd/server serving cert is signed for DNS names [k8s-master localhost] and IPs [192.168.92.56 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;etcd/peer&quot; certificate and key</span><br><span class="line">[certs] etcd/peer serving cert is signed for DNS names [k8s-master localhost] and IPs [192.168.92.56 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating &quot;ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;apiserver&quot; certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed for DNS names [k8s-master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.92.56]</span><br><span class="line">[certs] Generating &quot;apiserver-kubelet-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-ca&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;front-proxy-client&quot; certificate and key</span><br><span class="line">[certs] Generating &quot;sa&quot; key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder &quot;/etc/kubernetes&quot;</span><br><span class="line">[kubeconfig] Writing &quot;admin.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;kubelet.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;controller-manager.conf&quot; kubeconfig file</span><br><span class="line">[kubeconfig] Writing &quot;scheduler.conf&quot; kubeconfig file</span><br><span class="line">[control-plane] Using manifest folder &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-apiserver&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-controller-manager&quot;</span><br><span class="line">[control-plane] Creating static Pod manifest for &quot;kube-scheduler&quot;</span><br><span class="line">[etcd] Creating static Pod manifest for local etcd in &quot;/etc/kubernetes/manifests&quot;</span><br><span class="line">[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory &quot;/etc/kubernetes/manifests&quot;. This can take up to 4m0s</span><br><span class="line">[apiclient] All control plane components are healthy after 21.009858 seconds</span><br><span class="line">[uploadconfig] storing the configuration used in ConfigMap &quot;kubeadm-config&quot; in the &quot;kube-system&quot; Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap &quot;kubelet-config-1.13&quot; in namespace kube-system with the configuration for the kubelets in the cluster</span><br><span class="line">[patchnode] Uploading the CRI Socket information &quot;/var/run/dockershim.sock&quot; to the Node API object &quot;k8s-master&quot; as an annotation</span><br><span class="line">[mark-control-plane] Marking the node k8s-master as control-plane by adding the label &quot;node-role.kubernetes.io/master=&apos;&apos;&quot;</span><br><span class="line">[mark-control-plane] Marking the node k8s-master as control-plane by adding the taints [node-role.kubernetes.io/master:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: 60syk6.vnplamkn3zhwu3s3</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstraptoken] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster</span><br><span class="line">[bootstraptoken] creating the &quot;cluster-info&quot; ConfigMap in the &quot;kube-public&quot; namespace</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line">[addons] Applied essential addon: kube-proxy</span><br><span class="line"></span><br><span class="line">Your Kubernetes master has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p $HOME/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run &quot;kubectl apply -f [podnetwork].yaml&quot; with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now join any number of machines by running the following on each node</span><br><span class="line">as root:</span><br><span class="line"></span><br><span class="line">  kubeadm join 192.168.92.56:6443 --token 60syk6.vnplamkn3zhwu3s3 --discovery-token-ca-cert-hash sha256:7d50e704bbfe69661e37c5f3ad13b1b88032b6b2b703ebd4899e259477b5be69</span><br><span class="line"></span><br><span class="line">[root@k8s-master ~]#</span><br></pre></td></tr></table></figure>

<p>(注意记录下初始化结果中的kubeadm join命令，部署worker节点时会用到)</p>
<p>初始化过程说明：</p>
<p>1) [preflight] kubeadm 执行初始化前的检查。<br>2) [kubelet-start] 生成kubelet的配置文件”/var/lib/kubelet/config.yaml”<br>3) [certificates] 生成相关的各种token和证书<br>4) [kubeconfig] 生成 KubeConfig 文件，kubelet 需要这个文件与 Master 通信<br>5) [control-plane] 安装 Master 组件，会从指定的 Registry 下载组件的 Docker 镜像。<br>6) [bootstraptoken] 生成token记录下来，后边使用kubeadm join往集群中添加节点时会用到<br>7) [addons] 安装附加组件 kube-proxy 和 kube-dns。<br>8) Kubernetes Master 初始化成功，提示如何配置常规用户使用kubectl访问集群。<br>9) 提示如何安装 Pod 网络。<br>10) 提示如何注册其他节点到 Cluster。</p>
<ol start="8">
<li>配置 kubectl<br>kubectl 是管理 Kubernetes Cluster 的命令行工具，前面我们已经在所有的节点安装了 kubectl。Master 初始化完成后需要做一些配置工作，然后 kubectl 就能使用了。<br>依照 kubeadm init 输出的最后提示，推荐用 Linux 普通用户执行 kubectl。<ul>
<li>创建普通用户centos<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#创建普通用户并设置密码123456</span><br><span class="line">useradd centos &amp;&amp; echo &quot;centos:123456&quot; | chpasswd centos</span><br><span class="line"></span><br><span class="line">#追加sudo权限,并配置sudo免密</span><br><span class="line">sed -i &apos;/^root/a\centos  ALL=(ALL)       NOPASSWD:ALL&apos; /etc/sudoers</span><br><span class="line"></span><br><span class="line">#保存集群安全配置文件到当前用户.kube目录</span><br><span class="line">su - centos</span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">sudo chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"></span><br><span class="line">#启用 kubectl 命令自动补全功能（注销重新登录生效）</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ol>
<p>需要这些配置命令的原因是：Kubernetes 集群默认需要加密方式访问。所以，这几条命令，就是将刚刚部署生成的 Kubernetes 集群的安全配置文件，保存到当前用户的.kube 目录下，kubectl 默认会使用这个目录下的授权信息访问 Kubernetes 集群。<br>如果不这么做的话，我们每次都需要通过 export KUBECONFIG 环境变量告诉 kubectl 这个安全配置文件的位置。<br>配置完成后centos用户就可以使用 kubectl 命令管理集群了。</p>
<p>查看集群状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl get cs</span><br><span class="line">NAME STATUS MESSAGE ERROR</span><br><span class="line">scheduler Healthy ok</span><br><span class="line">controller-manager Healthy ok</span><br><span class="line">etcd-0 Healthy &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>确认各个组件都处于healthy状态。<br>查看节点状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl get nodes</span><br><span class="line">NAME         STATUS     ROLES    AGE   VERSION</span><br><span class="line">k8s-master   NotReady   master   36m   v1.13.1</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>可以看到，当前只存在1个master节点，并且这个节点的状态是 NotReady。<br>使用 kubectl describe 命令来查看这个节点（Node）对象的详细信息、状态和事件（Event）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl describe node k8s-master</span><br><span class="line">......</span><br><span class="line">Events:</span><br><span class="line">  Type    Reason                   Age                From                    Message</span><br><span class="line">  ----    ------                   ----               ----                    -------</span><br><span class="line">  Normal  Starting                 33m                kubelet, k8s-master     Starting kubelet.</span><br><span class="line">  Normal  NodeHasSufficientMemory  33m (x8 over 33m)  kubelet, k8s-master     Node k8s-master status is now: NodeHasSufficientMemory</span><br><span class="line">  Normal  NodeHasNoDiskPressure    33m (x8 over 33m)  kubelet, k8s-master     Node k8s-master status is now: NodeHasNoDiskPressure</span><br><span class="line">  Normal  NodeHasSufficientPID     33m (x7 over 33m)  kubelet, k8s-master     Node k8s-master status is now: NodeHasSufficientPID</span><br><span class="line">  Normal  NodeAllocatableEnforced  33m                kubelet, k8s-master     Updated Node Allocatable limit across pods</span><br><span class="line">  Normal  Starting                 33m                kube-proxy, k8s-master  Starting kube-proxy.</span><br></pre></td></tr></table></figure>

<p>通过 kubectl describe 指令的输出，我们可以看到 NodeNotReady 的原因在于，我们尚未部署任何网络插件，kube-proxy等组件还处于starting状态。<br>另外，我们还可以通过 kubectl 检查这个节点上各个系统 Pod 的状态，其中，kube-system 是 Kubernetes 项目预留的系统 Pod 的工作空间（Namepsace，注意它并不是 Linux Namespace，它只是 Kubernetes 划分不同工作空间的单位）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl get pod -n kube-system -o wide</span><br><span class="line">NAME                                 READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">coredns-78d4cf999f-7jdx7             1/1     Running   0          11h   10.244.0.3      k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-78d4cf999f-s6mhk             1/1     Running   0          11h   10.244.0.2      k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">etcd-k8s-master                      1/1     Running   1          11h   192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-k8s-master            1/1     Running   1          11h   192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-controller-manager-k8s-master   1/1     Running   1          11h   192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-flannel-ds-amd64-lkf2f          1/1     Running   0          10h   192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-proxy-przwf                     1/1     Running   1          11h   192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-scheduler-k8s-master            1/1     Running   1          11h   192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>可以看到，所有的系统 Pod 都成功启动了，而刚刚部署的flannel网络插件则在 kube-system 下面新建了一个名叫kube-flannel-ds-amd64-lkf2f的 Pod，一般来说，这些 Pod 就是容器网络插件在每个节点上的控制组件。<br>Kubernetes 支持容器网络插件，使用的是一个名叫 CNI 的通用接口，它也是当前容器网络的事实标准，市面上的所有容器网络开源项目都可以通过 CNI 接入 Kubernetes，比如 Flannel、Calico、Canal、Romana 等等，它们的部署方式也都是类似的“一键部署”。<br>再次查看master节点状态已经为ready状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl get nodes</span><br><span class="line">NAME         STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master   Ready    master   11h   v1.13.1</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>至此，Kubernetes 的 Master 节点就部署完成了。如果你只需要一个单节点的 Kubernetes，现在你就可以使用了。不过，在默认情况下，Kubernetes 的 Master 节点是不能运行用户 Pod 的。</p>
<ol start="10">
<li>部署worker节点</li>
</ol>
<p>Kubernetes 的 Worker 节点跟 Master 节点几乎是相同的，它们运行着的都是一个 kubelet 组件。唯一的区别在于，在 kubeadm init 的过程中，kubelet 启动后，Master 节点上还会自动运行 kube-apiserver、kube-scheduler、kube-controller-manger 这三个系统 Pod。<br>在 k8s-node1 和 k8s-node2 上分别执行如下命令，将其注册到 Cluster 中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#执行以下命令将节点接入集群</span><br><span class="line">kubeadm join 192.168.92.56:6443 --token 67kq55.8hxoga556caxty7s --discovery-token-ca-cert-hash sha256:7d50e704bbfe69661e37c5f3ad13b1b88032b6b2b703ebd4899e259477b5be69</span><br><span class="line"></span><br><span class="line">#如果执行kubeadm init时没有记录下加入集群的命令，可以通过以下命令重新创建</span><br><span class="line">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>

<p>在k8s-node1上执行kubeadm join ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@k8s-node1 ~]# kubeadm join 192.168.92.56:6443 --token 67kq55.8hxoga556caxty7s --discovery-token-ca-cert-hash sha256:7d50e704bbfe69661e37c5f3ad13b1b88032b6b2b703ebd4899e259477b5be69</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[discovery] Trying to connect to API Server &quot;192.168.92.56:6443&quot;</span><br><span class="line">[discovery] Created cluster-info discovery client, requesting info from &quot;https://192.168.92.56:6443&quot;</span><br><span class="line">[discovery] Requesting info from &quot;https://192.168.92.56:6443&quot; again to validate TLS against the pinned public key</span><br><span class="line">[discovery] Cluster info signature and contents are valid and TLS certificate validates against pinned roots, will use API Server &quot;192.168.92.56:6443&quot;</span><br><span class="line">[discovery] Successfully established connection with API Server &quot;192.168.92.56:6443&quot;</span><br><span class="line">[join] Reading configuration from the cluster...</span><br><span class="line">[join] FYI: You can look at this config file with &apos;kubectl -n kube-system get cm kubeadm-config -oyaml&apos;</span><br><span class="line">[kubelet] Downloading configuration for the kubelet from the &quot;kubelet-config-1.13&quot; ConfigMap in the kube-system namespace</span><br><span class="line">[kubelet-start] Writing kubelet configuration to file &quot;/var/lib/kubelet/config.yaml&quot;</span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file &quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span><br><span class="line">[kubelet-start] Activating the kubelet service</span><br><span class="line">[tlsbootstrap] Waiting for the kubelet to perform the TLS Bootstrap...</span><br><span class="line">[patchnode] Uploading the CRI Socket information &quot;/var/run/dockershim.sock&quot; to the Node API object &quot;k8s-node1&quot; as an annotation</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run &apos;kubectl get nodes&apos; on the master to see this node join the cluster.</span><br><span class="line"></span><br><span class="line">[root@k8s-node1 ~]#</span><br></pre></td></tr></table></figure>

<p>重复执行以上操作将k8s-node2也加进去（注意重新执行kubeadm token create –print-join-command）。<br>然后根据提示，我们可以通过 kubectl get nodes 查看节点的状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl get nodes</span><br><span class="line">NAME         STATUS   ROLES    AGE    VERSION</span><br><span class="line">k8s-master   Ready    master   11h    v1.13.1</span><br><span class="line">k8s-node1    Ready    &lt;none&gt;   24m    v1.13.1</span><br><span class="line">k8s-node2    Ready    &lt;none&gt;   4m9s   v1.13.1</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>nodes状态全部为ready，由于每个节点都需要启动若干组件，如果node节点的状态是 NotReady，可以查看所有节点pod状态，确保所有pod成功拉取到镜像并处于running状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl get pod --all-namespaces -o wide</span><br><span class="line">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE     IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">kube-system   coredns-78d4cf999f-7jdx7             1/1     Running   0          11h     10.244.0.3      k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   coredns-78d4cf999f-s6mhk             1/1     Running   0          11h     10.244.0.2      k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   etcd-k8s-master                      1/1     Running   1          12h     192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-apiserver-k8s-master            1/1     Running   1          12h     192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-controller-manager-k8s-master   1/1     Running   1          12h     192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-d2r8p          1/1     Running   0          6m43s   192.168.92.58   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-d85c6          1/1     Running   0          27m     192.168.92.57   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-flannel-ds-amd64-lkf2f          1/1     Running   0          11h     192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-k8jx8                     1/1     Running   0          6m43s   192.168.92.58   k8s-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-n95ck                     1/1     Running   0          27m     192.168.92.57   k8s-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-proxy-przwf                     1/1     Running   1          12h     192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-system   kube-scheduler-k8s-master            1/1     Running   1          12h     192.168.92.56   k8s-master   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>这时，所有的节点都已经 Ready，Kubernetes Cluster 创建成功，一切准备就绪。<br>如果pod状态为Pending、ContainerCreating、ImagePullBackOff 都表明 Pod 没有就绪，Running 才是就绪状态。<br>如果有pod提示Init:ImagePullBackOff，说明这个pod的镜像在对应节点上拉取失败，我们可以通过 kubectl describe pod 查看 Pod 具体情况，以确认拉取失败的镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl describe pod kube-flannel-ds-amd64-d2r8p --namespace=kube-system</span><br><span class="line">......</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                 From                Message</span><br><span class="line">  ----     ------     ----                ----                -------</span><br><span class="line">  Normal   Scheduled  2m14s               default-scheduler   Successfully assigned kube-system/kube-flannel-ds-amd64-lzx5v to k8s-node2</span><br><span class="line">  Warning  Failed     109s                kubelet, k8s-node2  Failed to pull image &quot;quay.io/coreos/flannel:v0.10.0-amd64&quot;: rpc error: code = Unknown desc = Error response from daemon: Get https://quay.io/v2/: net/http: TLS handshake timeout</span><br><span class="line">  Warning  Failed     109s                kubelet, k8s-node2  Error: ErrImagePull</span><br><span class="line">  Normal   BackOff    108s                kubelet, k8s-node2  Back-off pulling image &quot;quay.io/coreos/flannel:v0.10.0-amd64&quot;</span><br><span class="line">  Warning  Failed     108s                kubelet, k8s-node2  Error: ImagePullBackOff</span><br><span class="line">  Normal   Pulling    94s (x2 over 2m6s)  kubelet, k8s-node2  pulling image &quot;quay.io/coreos/flannel:v0.10.0-amd64&quot;</span><br></pre></td></tr></table></figure>

<p>这里看最后events输出内容，可以看到在下载 image 时失败，如果网络质量不好，这种情况是很常见的。我们可以耐心等待，因为 Kubernetes 会重试，我们也可以自己手工执行 docker pull 去下载这个镜像。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node2 ~]# docker pull quay.io/coreos/flannel:v0.10.0-amd64</span><br><span class="line">v0.10.0-amd64: Pulling from coreos/flannel</span><br><span class="line">ff3a5c916c92: Already exists</span><br><span class="line">8a8433d1d437: Already exists</span><br><span class="line">306dc0ee491a: Already exists</span><br><span class="line">856cbd0b7b9c: Already exists</span><br><span class="line">af6d1e4decc6: Already exists</span><br><span class="line">Digest: sha256:88f2b4d96fae34bfff3d46293f7f18d1f9f3ca026b4a4d288f28347fcb6580ac</span><br><span class="line">Status: Image is up to date for quay.io/coreos/flannel:v0.10.0-amd64</span><br><span class="line">[root@k8s-node2 ~]#</span><br></pre></td></tr></table></figure>

<p>如果无法从 quay.io/coreos/flannel:v0.10.0-amd64 下载镜像，可以从阿里云或者dockerhub镜像仓库下载，然后改回原来的tag即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/kubernetes_containers/flannel:v0.10.0-amd64</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/kubernetes_containers/flannel:v0.10.0-amd64 quay.io/coreos/flannel:v0.10.0-amd64</span><br><span class="line">docker rmi registry.cn-hangzhou.aliyuncs.com/kubernetes_containers/flannel:v0.10.0-amd64</span><br></pre></td></tr></table></figure>

<p>查看master节点下载了哪些镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ sudo docker images</span><br><span class="line">REPOSITORY                                                        TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-proxy                v1.13.1             fdb321fd30a0        2 weeks ago         80.2MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-apiserver            v1.13.1             40a63db91ef8        2 weeks ago         181MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-scheduler            v1.13.1             ab81d7360408        2 weeks ago         79.6MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-controller-manager   v1.13.1             26e6f1db2a52        2 weeks ago         146MB</span><br><span class="line">registry.aliyuncs.com/google_containers/coredns                   1.2.6               f59dcacceff4        8 weeks ago         40MB</span><br><span class="line">registry.aliyuncs.com/google_containers/etcd                      3.2.24              3cab8e1b9802        3 months ago        220MB</span><br><span class="line">quay.io/coreos/flannel                                            v0.10.0-amd64       f0fad859c909        11 months ago       44.6MB</span><br><span class="line">registry.aliyuncs.com/google_containers/pause                     3.1                 da86e6ba6ca1        12 months ago       742kB</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>查看node节点下载了哪些镜像：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-node1 ~]# docker images</span><br><span class="line">REPOSITORY                                           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-proxy   v1.13.1             fdb321fd30a0        2 weeks ago         80.2MB</span><br><span class="line">quay.io/coreos/flannel                               v0.10.0-amd64       f0fad859c909        11 months ago       44.6MB</span><br><span class="line">registry.aliyuncs.com/google_containers/pause        3.1                 da86e6ba6ca1        12 months ago       742kB</span><br><span class="line">[root@k8s-node1 ~]#</span><br></pre></td></tr></table></figure>

<p>测试集群各个组件<br>首先验证kube-apiserver, kube-controller-manager, kube-scheduler, pod network 是否正常：<br>部署一个 Nginx Deployment，包含2个Pod<br>参考：<a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/workloads/controllers/deployment/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl create deployment nginx --image=nginx:alpine</span><br><span class="line">deployment.apps/nginx created</span><br><span class="line">[centos@k8s-master ~]$ kubectl scale deployment nginx --replicas=2</span><br><span class="line">deployment.extensions/nginx scaled</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>验证Nginx Pod是否正确运行，并且会分配10.244.开头的集群IP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl get pods -l app=nginx -o wide</span><br><span class="line">NAME                     READY   STATUS    RESTARTS   AGE    IP           NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-54458cd494-p2qgx   1/1     Running   0          111s   10.244.1.2   k8s-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-54458cd494-sdlm7   1/1     Running   0          103s   10.244.2.2   k8s-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>再验证一下kube-proxy是否正常：</p>
<p>以 NodePort 方式对外提供服务<br>参考：<a href="https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/services-networking/connect-applications-service/</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl expose deployment nginx --port=80 --type=NodePort</span><br><span class="line">service/nginx exposed</span><br><span class="line">[centos@k8s-master ~]$ kubectl get services nginx</span><br><span class="line">NAME    TYPE       CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">nginx   NodePort   10.108.17.2   &lt;none&gt;        80:30670/TCP   12s</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>可以通过任意 NodeIP:Port 在集群外部访问这个服务：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ curl 192.168.92.56:30670</span><br><span class="line">[centos@k8s-master ~]$ curl 192.168.92.57:30670</span><br><span class="line">[centos@k8s-master ~]$ curl 192.168.92.58:30670</span><br></pre></td></tr></table></figure>

<p>访问k8s-master ip</p>
<p>最后验证一下dns, pod network是否正常：<br>运行Busybox并进入交互模式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl run -it curl --image=radial/busyboxplus:curl</span><br><span class="line">kubectl run --generator=deployment/apps.v1 is DEPRECATED and will be removed in a future version. Use kubectl run --generator=run-pod/v1 or kubectl create instead.</span><br><span class="line">If you don&apos;t see a command prompt, try pressing enter.</span><br><span class="line">[ root@curl-66959f6557-s5qqs:/ ]$</span><br></pre></td></tr></table></figure>

<p>输入nslookup nginx查看是否可以正确解析出集群内的IP，以验证DNS是否正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[ root@curl-66959f6557-s5qqs:/ ]$ nslookup nginx</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      nginx</span><br><span class="line">Address 1: 10.108.17.2 nginx.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<p>通过服务名进行访问，验证kube-proxy是否正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[ root@curl-66959f6557-q472z:/ ]$ curl http://nginx/</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">......</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[ root@curl-66959f6557-q472z:/ ]$</span><br></pre></td></tr></table></figure>

<p>分别访问一下2个Pod的内网IP，验证跨Node的网络通信是否正常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[ root@curl-66959f6557-s5qqs:/ ]$ curl 10.244.1.2</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">......</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[ root@curl-66959f6557-s5qqs:/ ]$ curl 10.244.2.2</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">......</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[ root@curl-66959f6557-s5qqs:/ ]$</span><br></pre></td></tr></table></figure>

<p>Pod调度到Master节点<br>出于安全考虑，默认配置下Kubernetes不会将Pod调度到Master节点。查看Taints字段默认配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl describe node k8s-master</span><br><span class="line">......</span><br><span class="line">Taints:             node-role.kubernetes.io/master:NoSchedule</span><br></pre></td></tr></table></figure>

<p>如果希望将k8s-master也当作Node节点使用，可以执行如下命令,其中k8s-master是主机节点hostname：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-master node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>

<p>修改后Taints字段状态：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl describe node k8s-master</span><br><span class="line">......</span><br><span class="line">Taints:             &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>如果要恢复Master Only状态，执行如下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint node k8s-master node-role.kubernetes.io/master=:NoSchedule</span><br></pre></td></tr></table></figure>

<p>kube-proxy开启ipvs<br>修改ConfigMap的kube-system/kube-proxy中的config.conf，mode: “ipvs”：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl edit cm kube-proxy -n kube-system</span><br><span class="line">configmap/kube-proxy edited</span><br></pre></td></tr></table></figure>

<p>之后重启各个节点上的kube-proxy pod：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl get pod -n kube-system | grep kube-proxy | awk &apos;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&apos;</span><br><span class="line">pod &quot;kube-proxy-2w9sh&quot; deleted</span><br><span class="line">pod &quot;kube-proxy-gw4lx&quot; deleted</span><br><span class="line">pod &quot;kube-proxy-thv4c&quot; deleted</span><br><span class="line">[centos@k8s-master ~]$ kubectl get pod -n kube-system | grep kube-proxy</span><br><span class="line">kube-proxy-6qlgv                        1/1     Running   0          65s</span><br><span class="line">kube-proxy-fdtjd                        1/1     Running   0          47s</span><br><span class="line">kube-proxy-m8zkx                        1/1     Running   0          52s</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>查看日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[centos@k8s-master ~]$ kubectl logs kube-proxy-6qlgv -n kube-system</span><br><span class="line">I1213 09:50:15.414493       1 server_others.go:189] Using ipvs Proxier.</span><br><span class="line">W1213 09:50:15.414908       1 proxier.go:365] IPVS scheduler not specified, use rr by default</span><br><span class="line">I1213 09:50:15.415021       1 server_others.go:216] Tearing down inactive rules.</span><br><span class="line">I1213 09:50:15.461658       1 server.go:464] Version: v1.13.0</span><br><span class="line">I1213 09:50:15.467827       1 conntrack.go:52] Setting nf_conntrack_max to 131072</span><br><span class="line">I1213 09:50:15.467997       1 config.go:202] Starting service config controller</span><br><span class="line">I1213 09:50:15.468010       1 controller_utils.go:1027] Waiting for caches to sync for service config controller</span><br><span class="line">I1213 09:50:15.468092       1 config.go:102] Starting endpoints config controller</span><br><span class="line">I1213 09:50:15.468100       1 controller_utils.go:1027] Waiting for caches to sync for endpoints config controller</span><br><span class="line">I1213 09:50:15.568766       1 controller_utils.go:1034] Caches are synced for endpoints config controller</span><br><span class="line">I1213 09:50:15.568950       1 controller_utils.go:1034] Caches are synced for service config controller</span><br><span class="line">[centos@k8s-master ~]$</span><br></pre></td></tr></table></figure>

<p>日志中打印出了Using ipvs Proxier，说明ipvs模式已经开启。</p>
<p>移除节点和集群<br>kubernetes集群移除节点<br>以移除k8s-node2节点为例，在Master节点上运行：<br>kubectl drain k8s-node2 –delete-local-data –force –ignore-daemonsets<br>kubectl delete node k8s-node2<br>上面两条命令执行完成后，在k8s-node2节点执行清理命令，重置kubeadm的安装状态：<br>kubeadm reset<br>在master上删除node并不会清理k8s-node2运行的容器，需要在删除节点上面手动运行清理命令。<br>如果你想重新配置集群，使用新的参数重新运行kubeadm init或者kubeadm join即可。</p>
<p>至此3个节点的集群搭建完成，后续可以继续添加node节点，或者部署dashboard、helm包管理工具、EFK日志系统、Prometheus Operator监控系统、rook+ceph存储系统等组件。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2019/12/21/kubernetes/" data-id="ckcfu66fy001no578gnaa2cl7" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="true-terminal_proxy" class="article article-type-true" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/21/terminal_proxy/" class="article-date">
  <time datetime="2019-12-21T01:18:38.059Z" itemprop="datePublished">2019-12-21</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/21/terminal_proxy/">让终端走socks5代理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <ol>
<li><p>把代理服务器地址写入shell配置文件.bashrc或者.zshrc<br>直接在.bashrc或者.zshrc添加下面内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=&quot;http://localhost:port&quot;</span><br><span class="line">export https_proxy=&quot;http://localhost:port&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>shadowsocks代理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export http_proxy=&quot;socks5://127.0.0.1:1080&quot;</span><br><span class="line">export https_proxy=&quot;socks5://127.0.0.1:1080&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ALL_PROXY</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alias setproxy=&quot;export ALL_PROXY=socks5://127.0.0.1:1080&quot;</span><br><span class="line">alias unsetproxy=&quot;unset ALL_PROXY&quot;</span><br></pre></td></tr></table></figure>

</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.newtao.vip/2019/12/21/terminal_proxy/" data-id="ckcfu66kf004do5787xc5gkx3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/GIT/">GIT</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/python/">python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/中间件/">中间件</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/交易所/">交易所</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/区块链/">区块链</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/后端/">后端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/汇编/">汇编</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/源码/">源码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络安全/">网络安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维/">运维</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/阿里云/">阿里云</a></li></ul>
    </div>
  </div>


  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/07/08/ctf/">安全领域资源</a>
          </li>
        
          <li>
            <a href="/2020/07/08/asm/">汇编指令集</a>
          </li>
        
          <li>
            <a href="/2020/07/08/asm_study/">汇编，栈溢出相关教程</a>
          </li>
        
          <li>
            <a href="/2020/06/17/sqlinject/">SQL 注入</a>
          </li>
        
          <li>
            <a href="/2020/06/05/htpasswd/">htpasswd</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 anonymous<br>
      Powered by <a href="https://baike.baidu.com/item/%E5%8C%BF%E5%90%8D%E8%80%85%E9%BB%91%E5%AE%A2%E7%BB%84%E7%BB%87/8378313?fromtitle=Anonymous&fromid=7157039&fr=aladdin" target="_blank">H</a>
      <a href="http://beian.miit.gov.cn">鲁ICP备18014570号</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  </div>
    <!-- waifu-tips.js 依赖 JQuery 库 -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <!-- 实现拖动效果，需引入 JQuery UI -->
    <script src="https://cdn.jsdelivr.net/npm/jquery-ui-dist@1.12.1/jquery-ui.min.js"></script>
    <script src="images/assets/autoload.js?v=1.4.2"></script>
</body>
</html>
